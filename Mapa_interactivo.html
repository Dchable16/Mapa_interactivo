<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <style>
        html, body { height: 100%; margin: 0; }
        #map { width: 100%; height: 100%; }
        .yellow-marker {
            background-color: #fff201;
            border: 3px solid black;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-block;
        }
        .marker-label {
            position: absolute;
            top: -40px; /* Ajustar la posición para evitar superposición */
            left: 25px;
            color: black;
            text-shadow: 0 0 2px yellow;
            font-weight: bold;
            font-size: 13px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6"></script>
</head>
<body>
    <h1>Mapa Interactivo</h1>
    <div>
        <label for="lat">Latitud:</label>
        <input type="text" id="lat" value="19.4326">
        <label for="lon">Longitud:</label>
        <input type="text" id="lon" value="-99.1332">
        <label for="markerName">Nombre del Marcador:</label>
        <input type="text" id="markerName" value="Marcador Manual">
        <button onclick="addMarker()">Agregar Marcador</button>
        <button onclick="removeMarker()">Eliminar Marcador</button>
        <button onclick="addRadius(400)">Agregar Radio 400m</button>
        <button onclick="addRadius(800)">Agregar Radio 800m</button>
    </div>
    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        // Inicializar el mapa
        var map = L.map("map").setView([19.4326, -99.1332], 12);

        // Capas base
        var osmLayer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"
        }).addTo(map);

        var googleRoadLayer = L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}", {
            attribution: "Google"
        });

        var googleHybridLayer = L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", {
            attribution: "Google"
        });

        // Objetos para almacenar las capas GeoJSON
        var geoJsonLayersAgeb = {};
        var geoJsonLayersUsoSuelo = {};
        var geoJsonLayersAlcaldias = {};

        // Variables para el marcador y los radios
        var currentMarker = null;
        var currentLabel = null;
        var radius400m = null;
        var radius800m = null;

        // Crear grupos de capas para los radios
        var radius400Layer = L.layerGroup().addTo(map);
        var radius800Layer = L.layerGroup().addTo(map);
        var radiusCutLayer = L.layerGroup().addTo(map); // Capa para el recorte

        // Función para agregar un marcador
        function addMarker() {
            // ... (código sin cambios) ...
        }

        // Función para eliminar el marcador
        function removeMarker() {
            // ... (código sin cambios) ...
        }

        // Función para agregar radios (sin cambios por ahora)
        function addRadius(radius) {
            // ... (código sin cambios) ...
        }

        // Función para calcular los puntos del polígono de recorte (sin cambios)
        function calculateCutPolygon(center, radius) {
            // ... (código sin cambios) ...
        }

        // Función para realizar el recorte y cálculo de áreas
        function recortarYCalcularAreas(marker) {
            var latLng = marker.getLatLng();

            // 1. Determinar ubicación del marcador (usando Turf.js)
            var punto = turf.point([latLng.lng, latLng.lat]);

            // Asegúrate de que las capas de alcaldías estén cargadas antes de usarlas
            if (geoJsonLayersAlcaldias['Capa Alcaldías CDMX'] && geoJsonLayersAlcaldias['Capa Municipios Edo. Mex.']) {
                var dentroCDMX = turf.booleanPointInPolygon(punto, geoJsonLayersAlcaldias['Capa Alcaldías CDMX'].toGeoJSON());
                var dentroEdoMex = turf.booleanPointInPolygon(punto, geoJsonLayersAlcaldias['Capa Municipios Edo. Mex.'].toGeoJSON());

                // 2. Seleccionar capa GeoJSON
                var capaSeleccionada = dentroCDMX ? geoJsonLayersAgeb['Capa CDMX'] : geoJsonLayersAgeb['Capa Edo Mex'];

                // 3. Recortar capa GeoJSON (usando Turf.js)
                var circulo400 = turf.circle([latLng.lng, latLng.lat], 400, { units: 'meters' });
                var circulo800 = turf.circle([latLng.lng, latLng.lat], 800, { units: 'meters' });

                var poligonosRecortados400 = turf.intersect(capaSeleccionada.toGeoJSON(), circulo400); // Intersección
                var diferenciaRadios = turf.difference(circulo800, circulo400); // Diferencia de radios
                var poligonosRecortadosDiferencia = turf.intersect(capaSeleccionada.toGeoJSON(), diferenciaRadios); // Intersección

                // 4. Calcular áreas (usando Turf.js)
                var areas400 = [];
                if (poligonosRecortados400 && poligonosRecortados400.features) { // Verificar si hay resultados
                    poligonosRecortados400.features.forEach(feature => {
                        areas400.push(turf.area(feature));
                    });
                }

                var areasDiferencia = [];
                if (poligonosRecortadosDiferencia && poligonosRecortadosDiferencia.features) { // Verificar si hay resultados
                    poligonosRecortadosDiferencia.features.forEach(feature => {
                        areasDiferencia.push(turf.area(feature));
                    });
                }

                console.log("Áreas dentro de 400m:", areas400);
                console.log("Áreas en la diferencia de radios:", areasDiferencia);

            } else {
                console.log("Capas de alcaldías no cargadas. Intenta mover el marcador más tarde.");
            }
        }

        // Llamar a la función al agregar o mover el marcador
        if (currentMarker) { // Verificar si currentMarker está definido
            currentMarker.on('move', function () {
                recortarYCalcularAreas(this);
            });
        }

        // Cargar capas GeoJSON
        function loadGeoJSON(url, layerName, type) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var geoJsonLayer = L.geoJSON(data, {
                        onEachFeature: function (feature, layer) {
                            // Mostrar los atributos en un popup al hacer clic
                            layer.on('click', function () {
                                var properties = feature.properties;
                                var popupContent = "<b>Atributos:</b><br>";
                                for (var key in properties) {
                                    popupContent += key + ": " + properties[key] + "<br>";
                                }
                                layer.bindPopup(popupContent).openPopup();
                            });
                        }
                    });

                    // Agregar la capa AL OBJETO y LUEGO al control
                    if (type === 'Ageb') {
                        geoJsonLayersAgeb[layerName] = geoJson