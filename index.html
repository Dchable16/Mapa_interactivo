<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net 'unsafe-eval'; font-src 'self' data: https://cdn.jsdelivr.net; img-src 'self' data: https://cdn.jsdelivr.net https://github.com https://raw.githubusercontent.com maps.googleapis.com *.gstatic.com mapstreet.com tile.openstreetmap.org mt1.google.com mt0.google.com *.khms.googleapis.com;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa interactivo Tiendas 3B</title>
    <link rel="icon" href="favicon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <style>
        html, body { height: 100%; margin: 0; }
        #map { width: 100%; height: calc(100-10px%); /* Ajustar altura del mapa */ }
        .yellow-marker { background-color: #fff201; border: 3px solid black; border-radius: 50%; width: 20px; height: 20px; display: inline-block; }
        .marker-label { position: absolute; top: -40px; left: 25px; color: black; text-shadow: 0 0 2px yellow; font-weight: bold; font-size: 13px; }
        .form-container { background-color: rgb(248, 248, 255); padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); margin: 20px auto; max-width: 600px; }
        .form-container label { color: rgb(0, 187, 45); font-weight: bold; }
        .form-container input { margin-bottom: 10px; padding: 5px; border: 1px solid rgb(0, 187, 45); border-radius: 5px; width: calc(100% - 12px); }
        .form-container button { background-color: rgb(230, 25, 25); color: white; border: none; border-radius: 5px; padding: 10px; cursor: pointer; width: 100%; font-weight: bold; }
        .form-container button:hover { background-color: rgb(200, 25, 25); }
        .button-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .logo { display: block; margin: 0 auto 20px; width: 120px; }
        .centered-title { text-align: center; margin: 20px 0; }
        .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .form-column { display: flex; flex-direction: column; }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .button-container { grid-template-columns: 1fr; }
            .logo { width: 100px; }
            body { padding: 6px; margin: 0; height: 100%; }
        }
        @media (min-width: 1024px) {
            .form-container { max-width: 65%; padding: 30px; }
            .form-container input, .form-container button { padding: 5px; font-size: 15px; }
            .logo { width: 200px; }
        }
    </style>
</head>
<body>
    <div class="header-container">
        <h1 class="centered-title">Mapa interactivo Tiendas 3B</h1>
        <img src="https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/main/Captura-removebg-preview.png" alt="Logotipo" class="logo">
    </div>
    <div class="form-container">
        <div class="form-row">
            <div class="form-column">
                <label for="lat">Latitud:</label>
                <input type="text" id="lat" value="19.4326">
            </div>
            <div class="form-column">
                <label for="lon">Longitud:</label>
                <input type="text" id="lon" value="-99.1332">
            </div>
            <div class="form-column">
                <label for="markerName">Nombre del Marcador:</label>
                <input type="text" id="markerName" value="Marcador Manual">
            </div>
        </div>
        
        <div class="button-container">
            <button onclick="addMarker()">Agregar Marcador</button>
            <button onclick="removeMarker()">Eliminar Marcador</button>
            <button onclick="addRadius(400)">Agregar Radio 400m</button>
            <button onclick="addRadius(800)">Agregar Radio 800m</button>
            <button onclick="calculateDifference()">Calcular Diferencia entre Radios</button>
            <button onclick="extractBufferData()">Extraer Información Ageb - Radio 400m</button>
            <button onclick="extractDifferenceData()">Extraer Información Ageb - Radio 800m</button>
        </div>
    </div>
    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        const map = L.map("map").setView([19.4326, -99.1332], 12);
        const osmLayer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"
        }).addTo(map);

        const googleRoadLayer = L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}", { attribution: "Google" });
        const googleHybridLayer = L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", { attribution: "Google" });

        // Definición de capas GeoJSON
        const geoJsonLayersAgeb = {};
        const geoJsonLayersUsoSuelo = {};
        const geoJsonLayersAlcaldias = {};
        const geoJsonLayersPoligonos = {};
        const geoJsonLayersColonias = {};
        const geoJsonLayersCompetencias = {};
        
        let currentMarker = null;
        let radius400m = null;
        let radius800m = null;
        let differenceLayer = null;

        const radius400Layer = L.layerGroup().addTo(map);
        const radius800Layer = L.layerGroup().addTo(map);
        const differenceLayerGroup = L.layerGroup().addTo(map);
        const bufferLayerGroup = L.layerGroup().addTo(map);
        const differenceExtractionLayerGroup = L.layerGroup().addTo(map);

        // Banderas para controlar la creación de elementos
        let radius400Created = false;
        let radius800Created = false;
        let differenceCreated = false;
        let bufferDataExtracted = false;
        let differenceDataExtracted = false;

        function addMarker() {
            if (currentMarker) {
                alert("Ya existe un marcador en el mapa. Elimínelo antes de agregar uno nuevo.");
                return;
            }

            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            const markerName = document.getElementById('markerName').value;

            if (!isNaN(lat) && !isNaN(lon)) {
                currentMarker = L.marker([lat, lon], {
                    icon: L.divIcon({ className: 'yellow-marker', iconSize: [12, 12], iconAnchor: [10, 20] })
                }).addTo(map).bindPopup(markerName).openPopup();
                map.setView([lat, lon], 12);
            } else {
                alert("Por favor ingrese coordenadas válidas.");
            }
        }

        function removeMarker() {
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
                radius400Layer.clearLayers();
                radius800Layer.clearLayers();
                if (differenceLayer) {
                    differenceLayerGroup.removeLayer(differenceLayer);
                    differenceLayer = null; // Limpiar la capa de diferencia
                }
                bufferLayerGroup.clearLayers();
                differenceExtractionLayerGroup.clearLayers();
                document.getElementById('lat').value = '';
                document.getElementById('lon').value = '';
                document.getElementById('markerName').value = '';
            } else {
                alert("No hay ningún marcador para eliminar.");
            }
        }

        function addRadius(radius) {
            if (radius === 400 && radius400Created) {
                alert("El radio de 400m ya ha sido creado.");
                return;
            }
            if (radius === 800 && radius800Created) {
                alert("El radio de 800m ya ha sido creado.");
                return;
            }

            if (currentMarker) {
                const latLng = currentMarker.getLatLng();
                const circle = L.circle(latLng, { color: radius === 400 ? 'blue' : 'red', fillOpacity: 0.2, radius: radius });
                if (radius === 400) {
                    radius400Layer.addLayer(circle);
                    radius400m = circle;
                    radius400Created = true; // Marcar como creado
                } else {
                    radius800Layer.addLayer(circle);
                    radius800m = circle;
                    radius800Created = true; // Marcar como creado
                }
            } else {
                alert("Primero debe agregar un marcador.");
            }
        }

        function calculateDifference() {
            if (differenceCreated) {
                alert("La diferencia entre radios ya ha sido calculada.");
                return;
            }

            if (currentMarker && radius400m && radius800m) {
                const latLng = currentMarker.getLatLng();
                const circle400 = turf.circle([latLng.lng, latLng.lat], 400, { units: 'meters' });
                const circle800 = turf.circle([latLng.lng, latLng.lat], 800, { units: 'meters' });
                const difference = turf.difference(circle800, circle400);
                if (difference) {
                    const geoJson = turf.featureCollection([difference]);
                    differenceLayer = L.geoJSON(geoJson, { style: { color: 'green', weight: 2, fillOpacity: 0.5 } }).addTo(differenceLayerGroup);
                    differenceCreated = true; // Marcar como creado
                } else {
                    alert("No se pudo calcular la diferencia entre los círculos.");
                }
            } else {
                alert("Asegúrese de que el marcador y ambos radios estén creados.");
            }
        }

        function extractBufferData() {
            if (bufferDataExtracted) {
                alert("La extracción de datos Ageb con el radio de 400m ya ha sido realizada.");
                return;
            }

            if (currentMarker) {
                const lat = parseFloat(document.getElementById('lat').value);
                const lon = parseFloat(document.getElementById('lon').value);
                const selectedLayer = (lat >= 19.0 && lat <= 20.0 && lon >= -100.0 && lon <= -98.0) ? 'Ageb_urb_CDMX.geojson' : 'Ageb_urb_Edo_Mex.geojson';
                fetch(selectedLayer)
                    .then(response => response.json())
                    .then(data => {
                        const buffer = turf.circle([lon, lat], 400, { units: 'meters' });
                        const featuresWithinBuffer = turf.featureCollection(data.features.map(feature => {
                            const intersection = turf.intersect(feature, buffer);
                            if (intersection) {
                                intersection.properties.area = Math.floor(turf.area(intersection));
                                return intersection;
                            }
                            return null;
                        }).filter(feature => feature !== null));
                        L.geoJSON(featuresWithinBuffer, {
                            style: { color: 'orange', weight: 2, fillOpacity: 0.5 },
                            onEachFeature: function (feature, layer) {
                                layer.on('click', function () {
                                    let popupContent = "<b>Atributos:</b><br>";
                                    for (const key in feature.properties) {
                                        popupContent += `${key}: ${feature.properties[key]}<br>`;
                                    }
                                    layer.bindPopup(popupContent).openPopup();
                                });
                            }
                        }).addTo(bufferLayerGroup);
                        bufferDataExtracted = true; // Marcar como creado
                    })
                    .catch(err => console.error('Error al cargar la capa base:', err));
            } else {
                alert("Primero debe agregar un marcador.");
            }
        }

        function extractDifferenceData() {
            if (differenceDataExtracted) {
                alert("La extracción de datos Ageb con el radio de 800m ya ha sido realizada.");
                return;
            }

            if (currentMarker) {
                const latLng = currentMarker.getLatLng();
                const circle400 = turf.circle([latLng.lng, latLng.lat], 400, { units: 'meters' });
                const circle800 = turf.circle([latLng.lng, latLng.lat], 800, { units: 'meters' });
                const difference = turf.difference(circle800, circle400);
                const selectedLayer = (latLng.lat >= 19.0 && latLng.lat <= 20.0 && latLng.lng >= -100.0 && latLng.lng <= -98.0) ? 'Ageb_urb_CDMX.geojson' : 'Ageb_urb_Edo_Mex.geojson';
                fetch(selectedLayer)
                    .then(response => response.json())
                    .then(data => {
                        const featuresWithinDifference = turf.featureCollection(data.features.map(feature => {
                            const intersection = turf.intersect(feature, difference);
                            if (intersection) {
                                intersection.properties.area = Math.floor(turf.area(intersection));
                                return intersection;
                            }
                            return null;
                        }).filter(feature => feature !== null));
                        L.geoJSON(featuresWithinDifference, {
                            style: { color: 'purple', weight: 2, fillOpacity: 0.5 },
                            onEachFeature: function (feature, layer) {
                                layer.on('click', function () {
                                    let popupContent = "<b>Atributos:</b><br>";
                                    for (const key in feature.properties) {
                                        popupContent += `${key}: ${feature.properties[key]}<br>`;
                                    }
                                    layer.bindPopup(popupContent).openPopup();
                                });
                            }
                        }).addTo(differenceExtractionLayerGroup);
                        differenceDataExtracted = true; // Marcar como creado
                    })
                    .catch(err => console.error('Error al cargar la capa base:', err));
            } else {
                alert("Asegúrese de que el marcador esté creado.");
            }
        }

        const customIcon = L.icon({
            iconUrl: 'https://github.com/Dchable16/Mapa_interactivo/raw/main/Captura-removebg-preview.png',
            iconSize: [20, 20],
            iconAnchor: [15, 30],
            popupAnchor: [0, -30]
        });

        function loadGeoJSON(url, layerName, type) {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`Error al cargar ${url}: ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    const colorMap = {
                        'UsoSuelo': 'rgb(128, 0, 128)',
                        'Poligono': 'rgb(255, 127, 80)',
                        'Col': 'rgb(0, 150, 136)',
                        'Region_Vallejo': 'rgb(204, 85, 0)',
                        'Municip_Estado_de_Mexico': 'rgb(255, 255, 0)',
                        'Alcaldias_Ciudad_de_México': 'rgb(230, 230, 250)',
                        'Competencias': 'rgb(204, 85, 0)',
                        'Ageb': url.includes('Ageb_urb_CDMX.geojson') ? 'rgb(135, 206, 235)' : 'rgb(128, 128, 0)',
                    };
                    const geoJsonLayer = L.geoJSON(data, {
                        pointToLayer: (feature, latlng) => L.marker(latlng, { icon: customIcon }),
                        style: { color: colorMap[type], weight: 2, fillOpacity: 0.5 },
                        onEachFeature: (feature, layer) => {
                            layer.on('click', () => {
                                let popupContent = "<b>Atributos:</b><br>";
                                for (const key in feature.properties) {
                                    popupContent += `${key}: ${feature.properties[key]}<br>`;
                                }
                                layer.bindPopup(popupContent).openPopup();
                            });
                        }
                    });
                    switch (type) {
                        case 'Ageb': geoJsonLayersAgeb[layerName] = geoJsonLayer; break;
                        case 'UsoSuelo': geoJsonLayersUsoSuelo[layerName] = geoJsonLayer; break;
                        case 'AlcaldiasMunicipios': geoJsonLayersAlcaldias[layerName] = geoJsonLayer; break;
                        case 'Poligono': geoJsonLayersPoligonos[layerName] = geoJsonLayer; break;
                        case 'Col': geoJsonLayersColonias[layerName] = geoJsonLayer; break;
                        case 'Competencias': geoJsonLayersCompetencias[layerName] = geoJsonLayer; break;
                    }
                    updateLayerControls();
                })
                .catch(err => console.error('Error al cargar GeoJSON:', err));
        }

        const baseMaps = {
            "OpenStreetMap": osmLayer,
            "Google Road": googleRoadLayer,
            "Google Hybrid": googleHybridLayer
        };

        const layerControlBase = L.control.layers(baseMaps, null).addTo(map);
        let layerControlAgeb = L.control.layers(null, geoJsonLayersAgeb, { collapsed: true }).addTo(map);
        let layerControlUsoSuelo = L.control.layers(null, geoJsonLayersUsoSuelo, { collapsed: true }).addTo(map);
        let layerControlAlcaldias = L.control.layers(null, geoJsonLayersAlcaldias, { collapsed: true }).addTo(map);
        let layerControlPoligonos = L.control.layers(null, geoJsonLayersPoligonos, { collapsed: true }).addTo(map);
        let layerControlColonias = L.control.layers(null, geoJsonLayersColonias, { collapsed: true }).addTo(map);
        let layerControlCompetencias = L.control.layers(null, geoJsonLayersCompetencias, { collapsed: true }).addTo(map);

        const layerControlRadios = L.control.layers(null, {
            "Radio 400m": radius400Layer,
            "Radio 800m": radius800Layer,
            "Diferencia entre Radios": differenceLayerGroup,
            "Extracción Ageb - Radio 400m": bufferLayerGroup,
            "Extracción Ageb - Radio 800m": differenceExtractionLayerGroup
        }, { collapsed: true }).addTo(map);

        function updateLayerControls() {
            layerControlAgeb.remove();
            layerControlUsoSuelo.remove();
            layerControlAlcaldias.remove();
            layerControlPoligonos.remove();
            layerControlColonias.remove();
            layerControlCompetencias.remove();
            layerControlAgeb = L.control.layers(null, geoJsonLayersAgeb, { collapsed: true }).addTo(map);
            layerControlUsoSuelo = L.control.layers(null, geoJsonLayersUsoSuelo, { collapsed: true }).addTo(map);
            layerControlAlcaldias = L.control.layers(null, geoJsonLayersAlcaldias, { collapsed: true }).addTo(map);
            layerControlPoligonos = L.control.layers(null, geoJsonLayersPoligonos, { collapsed: true }).addTo(map);
            layerControlColonias = L.control.layers(null, geoJsonLayersColonias, { collapsed: true }).addTo(map);
            layerControlCompetencias = L.control.layers(null, geoJsonLayersCompetencias, { collapsed: true }).addTo(map);
        }

        loadGeoJSON('Ageb_urb_CDMX.geojson', 'Ageb CDMX', 'Ageb');
        loadGeoJSON('Ageb_urb_Edo_Mex.geojson', 'Ageb Edo. Mex.', 'Ageb');
        loadGeoJSON('Uso_suelo_centro_barrio.geojson', 'Uso de suelo Centro Barrio', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_equipamento.geojson', 'Uso de suelo Equipamento', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_comercio.geojson', 'Uso de suelo Habitacional Comercio', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_comercio_planta_baja.geojson', 'Uso de suelo Planta Baja', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_entrada.geojson', 'Uso de suelo Entrada', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_mixto.geojson', 'Uso de suelo Mixto', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_oficinas.geojson', 'Uso de suelo Oficinas', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_plurifamiliar.geojson', 'Uso de suelo Plurifamiliar', 'UsoSuelo');
        loadGeoJSON('Alcaldias_Ciudad_de_México.geojson', 'Alcaldías CDMX', 'AlcaldiasMunicipios');
        loadGeoJSON('Municip_Estado_de_Mexico.geojson', 'Municipios Edo. Mex.', 'AlcaldiasMunicipios');
        loadGeoJSON('Region_Vallejo.geojson', 'Poligono Región Vallejo', 'Poligono');
        loadGeoJSON('Poligono_Azcapotzalco.geojson', 'Poligono Azcapotzalco', 'Poligono');
        loadGeoJSON('Poligono_Benito_Juarez.geojson', 'Poligono Benito Juárez', 'Poligono');
        loadGeoJSON('Poligono_Cuauhtemoc.geojson', 'Poligono Cuauhtémoc', 'Poligono');
        loadGeoJSON('Poligono_Ecatepec.geojson', 'Poligono Ecatepec', 'Poligono');
        loadGeoJSON('Poligono_Miguel_Hidalgo.geojson', 'Poligono M. Hidalgo', 'Poligono');
        loadGeoJSON('Poligono_Nezahualcoyotl.geojson', 'Poligono Nezahualcoyotl', 'Poligono');
        loadGeoJSON('Col_Azcapotzalco.geojson', 'Colonias Azcapotzalco', 'Col');
        loadGeoJSON('Col_Benito_Juarez.geojson', 'Colonias Benito Juárez', 'Col');
        loadGeoJSON('Col_Cuauhtemoc.geojson', 'Colonias Cuauhtemoc', 'Col');
        loadGeoJSON('Col_Ecatepec.geojson', 'Colonias Ecatepec', 'Col');
        loadGeoJSON('Col_Miguel_Hidalgo.geojson', 'Colonias M. Hidalgo', 'Col');
        loadGeoJSON('Col_Nezahualcoyotl.geojson', 'Colobias Nezahualcoyotl', 'Col');
        loadGeoJSON('Tiendas_3B.geojson', 'Tiendas 3B', 'Competencias'); 
    </script>
</body>
</html>
