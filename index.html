<!DOCTYPE html>
<html>
<head>
    <title>Mapa Interactivo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        #map { height: 500px; width: 100%; }
        #loading-indicator { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="download-report-btn">Descargar Reporte</button>
    <button id="realtime-location-button">Localización en Tiempo Real</button>
    <button id="useLocationBtn">Usar Localización</button>
    <button id="competencias-button">Competencias</button>
    <button id="calculate-btn">Calcular</button>
    <div id="loading-indicator">Cargando...</div>
    Latitud: <input type="text" id="lat"><br>
    Longitud: <input type="text" id="lon">

    <script>
        // --- Módulo: Variables Globales y Configuración Inicial ---
        const map = L.map('map').setView([19.4326, -99.1332], 13);
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const googleRoadLayer = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { subdomains: ['mt0', 'mt1', 'mt2', 'mt3'] });
        const googleHybridLayer = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { subdomains: ['mt0', 'mt1', 'mt2', 'mt3'] });
        let currentMarker = null;
        let ageb400Data = [];
        let ageb800Data = [];
        const geoJsonCache = {};
        const loadedLayers = new Set();
        const geoJsonLayersAgeb = {};
        const geoJsonLayersUsoSuelo = {};
        const geoJsonLayersAlcaldias = {};
        const geoJsonLayersPoligonos = {};
        const geoJsonLayersColonias = {};
        const geoJsonLayersCompetencias = {};
        let agebCDMXLayer = null;
        let agebEdoMexLayer = null;
        const radius400Layer = L.layerGroup().addTo(map);
        const radius800Layer = L.layerGroup().addTo(map);
        const differenceLayerGroup = L.layerGroup().addTo(map);
        const bufferLayerGroup = L.layerGroup().addTo(map);
        const differenceExtractionLayerGroup = L.layerGroup().addTo(map);
        const layerControlContainer = L.control({ position: 'topright' });

        // --- Módulo: Generación de Reportes ---
        function generateReport() {
            if (ageb400Data.length === 0 && ageb800Data.length === 0) {
                alert("No hay datos para generar el reporte.");
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,";
            if (ageb400Data.length > 0) {
                csvContent += "AGEB 400m\n";
                csvContent += "POB1,Area_original,Area_Extraida,Porcentaje_Area,Poblacion_Total\n";
                ageb400Data.forEach(item => {
                    csvContent += `<span class="math-inline">\{item\.POB1\},</span>{item.originalArea},<span class="math-inline">\{item\.extractedArea\},</span>{item.extractionPercentage},${item.populationTotal}\n`;
                });
                csvContent += "\n";
            }
            if (ageb800Data.length > 0) {
                csvContent += "AGEB 800m\n";
                csvContent += "POB1,Area_original,Area_Extraida,Porcentaje_Area,Poblacion_Total\n";
                ageb800Data.forEach(item => {
                    csvContent += `<span class="math-inline">\{item\.POB1\},</span>{item.originalArea},<span class="math-inline">\{item\.extractedArea\},</span>{item.extractionPercentage},${item.populationTotal}\n`;
                });
            }
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "reporte_ageb.csv");
            document.body.appendChild(link);
            link.click();
        }
        document.getElementById('download-report-btn').addEventListener('click', generateReport);

        // --- Módulo: Iconos Personalizados ---
        const customIcon = L.icon({
            iconUrl: 'https://github.com/Dchable16/Mapa_interactivo/raw/main/Captura-removebg-preview.png',
            iconSize: [20, 20],
            iconAnchor: [15, 30],
            popupAnchor: [0, -30]
        });
        const iconosPersonalizados = {
            'Bodega_Aurrera': L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Bodega_Aurrera.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }),
            'Bodega_Aurrera_Express': L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Bodega_Aurrera.png', iconSize:[20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }),
            'Primarias': L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Escuela.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }),
            'Tiendas_3B': L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Captura-removebg-preview.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }),
            'Tiendas_Neto': L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Tienda_neto.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] })
        };

        // --- Módulo: Simplificación de Geometrías ---
        function simplifyGeoJSON(data, tolerance) {
            return {
                type: "FeatureCollection",
                features: data.features.map(feature => {
                    return turf.simplify(feature, { tolerance: tolerance, highQuality: true });
                })
            };
        }

        // --- Módulo: Carga y Gestión de Capas GeoJSON ---
        function mostrarIndicadorCarga() { document.getElementById('loading-indicator').style.display = 'block'; }
        function ocultarIndicadorCarga() { document.getElementById('loading-indicator').style.display = 'none'; }

        function loadGeoJSON(url, layerName, type, callback) {
            if (loadedLayers.has(layerName)) { console.log(`La capa ${layerName} ya ha sido cargada.`); if (callback) callback(); return; }
            if (geoJsonCache[url]) { console.log(`Cargando desde caché: ${layerName}`); const data = geoJsonCache[url]; processGeoJSONData(data, layerName, type); if (callback) callback(); return; }
            fetch(url)
                .then(response => { if (!response.ok) throw new Error(`Error al cargar ${url}: ${response.statusText}`); return response.json(); })
                .then(data => {
                    geoJsonCache[url] = data;
                    if (type === 'UsoSuelo') { data = simplifyGeoJSON(data, 0.0000005); }
                    const colorMap = { 'UsoSuelo': 'rgb(128, 0, 128)', 'Poligono': 'rgb(255, 127, 80)', 'Col': 'rgb(0, 150, 136)', 'Region_Vallejo': 'rgb(204, 85, 0)', 'Municipios': 'rgb(255, 255, 0)', 'Alcaldias': 'rgb(0, 255, 127)', 'Competencias': 'rgb(204, 85, 0)', 'Ageb': url.includes('Ageb_urb_CDMX.geojson') ? 'rgb(135, 206, 235)' : 'rgb(128, 128, 0)' };
                    const geoJsonLayer = L.geoJSON(data, {
                        pointToLayer: function(feature, latlng) {
                            let icono = null;
                            if (type === 'Competencias') { icono = iconosPersonalizados[data.name]; console.log("Competencia name:", data.name); } else { icono = iconosPersonalizados[feature.properties.layerName]; console.log("layerName:", feature.properties.layerName); }
                            if (!icono) { icono = L.icon({ iconUrl: 'https://github.com/Dchable16/Mapa_interactivo/raw/77c9376848e01d5ce6ce89c08572ce51bf200f2e/Captura-removebg-preview.png', iconSize: [25, 25], iconAnchor: [12, 25], popupAnchor: [0, -28] }); }
                            return L.marker(latlng, { icon: icono });
                        },
                        style: (feature) => {
                            if (type === 'UsoSuelo') { return { color: 'rgb(128, 0, 128)', weight: 0.3, fillOpacity: 0 }; } else { return { color: colorMap[type], weight: 2, fillOpacity: 0.35 }; }
                        },
                        onEachFeature: (feature, layer) => {
                            if (type === 'Poligono') { const area = Math.floor(turf.area(feature)); feature.properties['Área polígono'] = area; }
                            if (type === 'Ageb') { layer.bindTooltip(feature.properties.POB1.toString(), { permanent: true, direction: 'center', className: 'ageb-label', offset: [0, 0], opacity: 1 }).openTooltip(); }
                            layer.on('click', () => {
                                let popupContent = "<b>Atributos:</b><br>";
                                for (const key in feature.properties) { if (key !== 'liga_ciuda') { popupContent += `${key}: ${feature.properties[key]}<br>`; } }
                                layer.bindPopup(popupContent).openPopup();
                            });
                        }
                    });
                    switch (type) {
                        case 'Ageb': if (url === 'Ageb_urb_CDMX.geojson') { agebCDMXLayer = geoJsonLayer; } else if (url === 'Ageb_urb_Edo_Mex.geojson') { agebEdoMexLayer = geoJsonLayer; } geoJsonLayersAgeb[layerName] = geoJsonLayer; break;
                        case 'UsoSuelo': geoJsonLayersUsoSuelo[layerName] = geoJsonLayer; break;
                        case 'Alcaldias': geoJsonLayersAlcaldias[layerName] = geoJsonLayer; break;
                        case 'Municipios': geoJsonLayersAlcaldias[layerName] = geoJsonLayer; break;
                        case 'Poligono': geoJsonLayersPoligonos[layerName] = geoJsonLayer; break;
                        case 'Col': geoJsonLayersColonias[layerName] = geoJsonLayer; break;
                        case 'Competencias': geoJsonLayersCompetencias[layerName] = geoJsonLayer; break;
                    }
                    loadedLayers.add(layerName);
                    updateLayerControls();
                    if (callback) callback();
                })
                .catch(err => console.error('Error al cargar GeoJSON:', err));
        }

        function loadLayer(layerName, type) {
            const layerUrls = {
                'Ageb CDMX': 'Ageb_urb_CDMX.geojson', 'Ageb Edo. Mex.': 'Ageb_urb_Edo_Mex.geojson', 'Uso de suelo Centro Barrio': 'Uso_suelo_centro_barrio.geojson', 'Uso de suelo Equipamento': 'Uso_suelo_equipamento.geojson', 'Uso de suelo Habitacional Comercio': 'Uso_suelo_habitacional_comercio.geojson', 'Uso de suelo Planta Baja': 'Uso_suelo_habitacional_comercio_planta_baja.geojson', 'Uso de suelo Entrada': 'Uso_suelo_habitacional_entrada.geojson', 'Uso de suelo Mixto': 'Uso_suelo_habitacional_mixto.geojson', 'Uso de suelo Oficinas': 'Uso_suelo_habitacional_oficinas.geojson', 'Uso de suelo Plurifamiliar': 'Uso_suelo_habitacional_plurifamiliar.geojson', 'Region Vallejo': 'Region_Vallejo.geojson', 'Alcaldias': 'Alcaldias.geojson', 'Municipios': 'Municipios.geojson', 'Poligono': 'Poligigono.geojson', 'Colonias': 'Colonias.geojson', 'Competencias': 'Competencias.geojson'
            };
            const url = layerUrls[layerName];
            if (url) { loadGeoJSON(url, layerName, type); } else { console.error(`URL no encontrada para la capa: ${layerName}`); }
        }

        function updateLayerControls() {
            if (layerControlContainer._map) { layerControlContainer.remove(); }
            const baseLayers = { "OpenStreetMap": osmLayer, "Google Road": googleRoadLayer, "Google Hybrid": googleHybridLayer };
            const groupedOverlays = {
                "AGEB": geoJsonLayersAgeb, "Uso de Suelo": geoJsonLayersUsoSuelo, "Alcaldias": geoJsonLayersAlcaldias, "Municipios": geoJsonLayersAlcaldias, "Polígonos": geoJsonLayersPoligonos, "Colonias": geoJsonLayersColonias, "Competencias": geoJsonLayersCompetencias, "Radios": { "Radio 400m": radius400Layer, "Radio 800m": radius800Layer }, "Extracción": { "Buffer": bufferLayerGroup, "Diferencia": differenceLayerGroup, "Extracción": differenceExtractionLayerGroup }
            };
            layerControlContainer.onAdd = function() {
                const div = L.DomUtil.create('div', 'leaflet-control-layers');
                const baseLayersDiv = L.DomUtil.create('div', 'leaflet-control-layers-base', div);
                const overlaysDiv = L.DomUtil.create('div', 'leaflet-control-layers-overlays', div);
                for (const name in baseLayers) {
                    const layerId = L.Util.stamp(baseLayers[name]);
                    baseLayersDiv.innerHTML += `<label><input type="radio" name="leaflet-base-layers" class="leaflet-control-layers-selector" value="${layerId}" <span class="math-inline">\{baseLayers\[name\] \=\=\= osmLayer ? 'checked' \: ''\}\><span\></span>{name}</span></label>`;
                }
                for (const groupName in groupedOverlays) {
                    const groupDiv = L.DomUtil.create('div', 'leaflet-control-layers-group', overlaysDiv);
                    groupDiv.innerHTML += `<strong>${groupName}</strong>`;
                    const layers = groupedOverlays[groupName];
                    if (layers instanceof L.LayerGroup) {
                        const layerId = L.Util.stamp(layers);
                        groupDiv.innerHTML += `<label><input type="checkbox" class="leaflet-control-layers-selector" value="${layerId}" <span class="math-inline">\{map\.hasLayer\(layers\) ? 'checked' \: ''\}\><span\></span>{groupName}</span></label>`;
                    } else {
                        for (const layerName in layers) {
                            const layerId = L.Util.stamp(layers[layerName]);
                            groupDiv.innerHTML += `<label><input type="checkbox" class="leaflet-control-layers-selector" value="${layerId}" <span class="math-inline">\{map\.hasLayer\(layers\[layerName\]\) ? 'checked' \: ''\}\><span\></span>{layerName}</span></label>`;
                        }
                    }
                }
                L.DomEvent.on(div, 'click', (e) => {
                    const target = e.target;
                    if (target.classList.contains('leaflet-control-layers-selector')) {
                        const layerId = parseInt(target.value);
                        if (target.type === 'radio') {
                            for (const name in baseLayers) {
                                if (L.Util.stamp(baseLayers[name]) === layerId) {
                                    map.eachLayer(layer => { if (layer instanceof L.TileLayer) { map.removeLayer(layer); } });
                                    baseLayers[name].addTo(map);
                                    break;
                                }
                            }
                        } else if (target.type === 'checkbox') {
                            for (const groupName in groupedOverlays) {
                                const layers = groupedOverlays[groupName];
                                if (layers instanceof L.LayerGroup && L.Util.stamp(layers) === layerId) {
                                    if (map.hasLayer(layers)) { map.removeLayer(layers); } else { layers.addTo(map); }
                                    break;
                                } else {
                                    for (const layerName in layers) {
                                        if (L.Util.stamp(layers[layerName]) === layerId) {
                                            if (map.hasLayer(layers[layerName])) { map.removeLayer(layers[layerName]); } else { layers[layerName].addTo(map); }
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
                L.DomEvent.on(div, 'mouseover', () => L.DomUtil.addClass(div, 'leaflet-control-layers-expanded'));
                L.DomEvent.on(div, 'mouseout', () => L.DomUtil.removeClass(div, 'leaflet-control-layers-expanded'));
                return div;
            };
            layerControlContainer.addTo(map);
            L.DomUtil.removeClass(layerControlContainer.getContainer(), 'leaflet-control-layers-expanded');
        }

        // --- Módulo: Geolocalización en Tiempo Real ---
        let watchId = null;
        let realtimeMarker = null;
        let isRealtimeLocationActive = false;
        let initialLocationReceived = false;

        function startRealtimeLocation() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        if (realtimeMarker) { realtimeMarker.setLatLng([latitude, longitude]); } else {
                            realtimeMarker = L.marker([latitude, longitude], { icon: customIcon }).addTo(map);
                            if (!initialLocationReceived) { map.setView([latitude, longitude], 15); initialLocationReceived = true; }
                        }
                    },
                    error => {
                        alert(`Error de geolocalización: ${error.message}`);
                        stopRealtimeLocation();
                    },
                    { enableHighAccuracy: true }
                );
                isRealtimeLocationActive = true;
            } else {
                alert("Geolocalización no soportada por el navegador.");
            }
        }

        function stopRealtimeLocation() {
            if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
            if (realtimeMarker) { map.removeLayer(realtimeMarker); realtimeMarker = null; }
            isRealtimeLocationActive = false;
        }

        document.getElementById('realtime-location-button').addEventListener('click', () => {
            if (isRealtimeLocationActive) { stopRealtimeLocation(); } else { startRealtimeLocation(); }
        });

        // --- Módulo: Búsqueda de Puntos de Interés (Competencias) ---
        const poiMarkers = L.markerClusterGroup();
        let requestQueue = [];
        let isProcessingQueue = false;

        const categorias = {
            hospitales: { query: 'hospital', icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Hospital.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }) },
            mercados: { query: 'market', icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Mercado.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }) },
            iglesias: { query: 'church', icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Iglesia.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }) },
            preescolar: { query: 'kindergarten', icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Escuela.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }) },
            primarias: { query: 'primary school', icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Escuela.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }) },
            bodegaAurrera: { query: 'Bodega Aurrera', icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Bodega_Aurrera.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }) },
            bodegaAurreraExpress: { query: 'Bodega Aurrera Express', icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Bodega_Aurrera.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }) },
            chedrauiSupercito: { query: 'Chedraui Supercito', icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/532dbbc949250be6d8136bf1810083f1a2c97d36/Chedraui.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }) },
            tiendas3B: { query: 'Tiendas 3B', icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Captura-removebg-preview.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }) },
            tiendasNeto: { query: 'Tiendas Neto', icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/2c9adbc2ea04e932363488957608dc5cecb59526/Tienda_neto.png', iconSize: [20, 20], iconAnchor: [10, 20], popupAnchor: [0, -20] }) }
        };

        function buscarCompetencias(lat, lon) {
            poiMarkers.clearLayers();
            map.addLayer(poiMarkers);
            for (const categoria in categorias) {
                const { query, icon } = categorias[categoria];
                const url = `https://nominatim.openstreetmap.org/search?q=<span class="math-inline">\{query\}&format\=geojson&viewbox\=</span>{lon - 0.01},<span class="math-inline">\{lat \- 0\.01\},</span>{lon + 0.01},${lat + 0.01}&bounded=1`;
                requestQueue.push({ url, icon });
            }
            if (!isProcessingQueue) { processRequestQueue(); }
        }

        function processRequestQueue() {
            if (requestQueue.length === 0) { isProcessingQueue = false; return; }
            isProcessingQueue = true;
            const { url, icon } = requestQueue.shift();
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.features) {
                        data.features.forEach(feature => {
                            if (feature.geometry && feature.geometry.coordinates) {
                                const [lon, lat] = feature.geometry.coordinates;
                                const marker = L.marker([lat, lon], { icon: icon }).bindPopup(feature.properties.display_name);
                                poiMarkers.addLayer(marker);
                            }
                        });
                    }
                    setTimeout(processRequestQueue, 1000);
                })
                .catch(err => {
                    console.error('Error al buscar competencias:', err);
                    setTimeout(processRequestQueue, 1000);
                });
        }

        document.getElementById('competencias-button').addEventListener('click', () => {
            if (currentMarker) {
                const latlng = currentMarker.getLatLng();
                buscarCompetencias(latlng.lat, latlng.lng);
            } else if (realtimeMarker) {
                const latlng = realtimeMarker.getLatLng();
                buscarCompetencias(latlng.lat, latlng.lng);
            } else {
                alert("Por favor, coloca un marcador o activa la localización en tiempo real.");
            }
        });

        // --- Módulo: Eventos y Funciones Auxiliares ---
        map.on('click', e => {
            if (currentMarker) { map.removeLayer(currentMarker); }
            currentMarker = L.marker(e.latlng, { icon: customIcon }).addTo(map);
            document.getElementById('lat').value = e.latlng.lat;
            document.getElementById('lon').value = e.latlng.lng;
        });

        document.getElementById('useLocationBtn').addEventListener('click', () => {
            if (realtimeMarker) {
                const latlng = realtimeMarker.getLatLng();
                document.getElementById('lat').value = latlng.lat;
                document.getElementById('lon').value = latlng.lng;
                if (currentMarker) { map.removeLayer(currentMarker); }
                currentMarker = L.marker(latlng, { icon: customIcon }).addTo(map);
            } else {
                alert("La localización en tiempo real no está activa.");
            }
        });

        // --- Funciones para calcular radios, AGEB y extracción ---

        function calcular(lat, lon) {
            clearLayers();
            const center = turf.point([lon, lat]);
            const options = { steps: 64, units: 'meters' };
            const circle400 = turf.circle(center, 400, options);
            const circle800 = turf.circle(center, 800, options);
            L.geoJSON(circle400, { style: { color: 'red', fillOpacity: 0 } }).addTo(radius400Layer);
            L.geoJSON(circle800, { style: { color: 'blue', fillOpacity: 0 } }).addTo(radius800Layer);
            calcularAGEB(circle400, circle800);
        }

        function clearLayers() {
            radius400Layer.clearLayers();
            radius800Layer.clearLayers();
            differenceLayerGroup.clearLayers();
            bufferLayerGroup.clearLayers();
            differenceExtractionLayerGroup.clearLayers();
            ageb400Data = [];
            ageb800Data = [];
        }

        function calcularAGEB(circle400, circle800) {
            function processAgebLayer(layer, circle, dataArray) {
                if (!layer) return;
                layer.eachLayer(agebLayer => {
                    if (agebLayer instanceof L.GeoJSON) {
                        agebLayer.eachLayer(featureLayer => {
                            if (featureLayer.feature) {
                                const intersection = turf.intersect(circle, featureLayer.feature);
                                if (intersection) {
                                    const originalArea = turf.area(featureLayer.feature);
                                    const extractedArea = turf.area(intersection);
                                    const extractionPercentage = (extractedArea / originalArea) * 100;
                                    dataArray.push({
                                        POB1: featureLayer.feature.properties.POB1,
                                        originalArea: originalArea,
                                        extractedArea: extractedArea,
                                        extractionPercentage: extractionPercentage,
                                        populationTotal: featureLayer.feature.properties.POBTOT
                                    });L.geoJSON(intersection, { style: { color: 'green', fillOpacity: 0.5 } }).addTo(differenceExtractionLayerGroup);
                                }
                            }
                        });
                    }
                });
            }
            processAgebLayer(agebCDMXLayer, circle400, ageb400Data);
            processAgebLayer(agebEdoMexLayer, circle400, ageb400Data);
            processAgebLayer(agebCDMXLayer, circle800, ageb800Data);
            processAgebLayer(agebEdoMexLayer, circle800, ageb800Data);
        }

        document.getElementById('calculate-btn').addEventListener('click', () => {
            if (currentMarker) {
                const latlng = currentMarker.getLatLng();
                calcular(latlng.lat, latlng.lng);
            } else if (realtimeMarker) {
                const latlng = realtimeMarker.getLatLng();
                calcular(latlng.lat, latlng.lng);
            } else {
                alert("Por favor, coloca un marcador o activa la localización en tiempo real.");
            }
        });

        // --- Inicialización de Capas ---
        loadLayer('Ageb CDMX', 'Ageb');
        loadLayer('Ageb Edo. Mex.', 'Ageb');
        loadLayer('Uso de suelo Centro Barrio', 'UsoSuelo');
        loadLayer('Uso de suelo Equipamento', 'UsoSuelo');
        loadLayer('Uso de suelo Habitacional Comercio', 'UsoSuelo');
        loadLayer('Uso de suelo Planta Baja', 'UsoSuelo');
        loadLayer('Uso de suelo Entrada', 'UsoSuelo');
        loadLayer('Uso de suelo Mixto', 'UsoSuelo');
        loadLayer('Uso de suelo Oficinas', 'UsoSuelo');
        loadLayer('Uso de suelo Plurifamiliar', 'UsoSuelo');
        loadLayer('Region Vallejo', 'Region_Vallejo');
        loadLayer('Alcaldias', 'Alcaldias');
        loadLayer('Municipios', 'Municipios');
        loadLayer('Poligono', 'Poligono');
        loadLayer('Colonias', 'Col');
        loadLayer('Competencias', 'Competencias');

    </script>
</body>
</html>
