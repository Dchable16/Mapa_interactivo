<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net 'unsafe-eval'; font-src 'self' data: https://cdn.jsdelivr.net; img-src 'self' data: https://cdn.jsdelivr.net https://github.com https://raw.githubusercontent.com maps.googleapis.com *.gstatic.com mapstreet.com tile.openstreetmap.org mt1.google.com mt0.google.com *.khms.googleapis.com;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa interactivo Tiendas 3B</title>
    <link rel="icon" href="favicon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <style>
        /* Estilos generales para el mapa y los marcadores */
        html, body { height: 100%; margin: 0; }
        #map { width: 100%; height: 100%; }
        .yellow-marker {
            background-color: #fff201;
            border: 3px solid black;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-block;
        }
        .marker-label {
            position: absolute;
            top: -40px;
            left: 25px;
            color: black;
            text-shadow: 0 0 2px yellow;
            font-weight: bold;
            font-size: 13px;
        }
        /* Estilos para el formulario */
        .form-container {
            background-color: rgb(248, 248, 255);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin: 20px auto;
            max-width: 600px;
        }
        .form-container label {
            color: rgb(0, 187, 45);
            font-weight: bold;
        }
        .form-container input, .form-container button {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
            width: calc(100% - 12px);
        }
        .form-container input {
            border: 1px solid rgb(0, 187, 45);
        }
        .form-container button {
            background-color: rgb(230, 25, 25);
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        .form-container button:hover {
            background-color: rgb(200, 25, 25);
        }
        /* Estilo para el contenedor de botones */
        .button-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        /* Estilo para el logotipo */
        .logo {
            display: block;
            margin: 0 auto 20px;
            width: 120px;
        }
        /* Estilo para centrar el título */
        .centered-title {
            text-align: center;
            margin: 20px 0;
        }
        /* Estilo para las filas del formulario */
        .form-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .form-column {
            display: flex;
            flex-direction: column;
        }
        /* Media queries para diseño responsivo */
        @media (max-width: 768px) {
            .form-row, .button-container { grid-template-columns: 1fr; }
            .logo { width: 100px; }
            body { padding: 6px; }
        }
        @media (min-width: 1024px) {
            .form-container { max-width: 65%; padding: 30px; }
            .form-container input, .form-container button { padding: 5px; font-size: 15px; }
            .logo { width: 200px; }
        }
    </style>
</head>
<body>
    <div class="header-container">
        <h1 class="centered-title">Mapa interactivo Tiendas 3B</h1>
        <img src="https://raw.githubusercontent.com/Dchable16/Mapa_interactivo/main/Captura-removebg-preview.png" alt="Logotipo" class="logo">
    </div>
    <div class="form-container">
        <div class="form-row">
            <div class="form-column">
                <label for="lat">Latitud:</label>
                <input type="text" id="lat" value="19.4326">
            </div>
            <div class="form-column">
                <label for="lon">Longitud:</label>
                <input type="text" id="lon" value="-99.1332">
            </div>
            <div class="form-column">
                <label for="markerName">Nombre del Marcador:</label>
                <input type="text" id="markerName" value="Marcador Manual">
            </div>
        </div>
        <div class="button-container">
            <button onclick="addMarker()">Agregar Marcador</button>
            <button onclick="removeMarker()">Eliminar Marcador</button>
            <button onclick="addRadius(400)">Agregar Radio 400m</button>
            <button onclick="addRadius(800)">Agregar Radio 800m</button>
            <button onclick="calculateDifference()">Calcular Diferencia entre Radios</button>
            <button onclick="extractBufferData()">Extraer Información Ageb - Radio 400m</button>
            <button onclick="extractDifferenceData()">Extraer Información Ageb - Radio 800m</button>
        </div>
    </div>
    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        const map = L.map("map").setView([19.4326, -99.1332], 12);
        const osmLayer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"
        }).addTo(map);

        const geoJsonLayers = {
            Ageb: {},
            UsoSuelo: {},
            Alcaldias: {},
            Poligonos: {},
            Colonias: {},
            Competencias: {}
        };

        const radius400Layer = L.layerGroup().addTo(map);
        const radius800Layer = L.layerGroup().addTo(map);
        const differenceLayerGroup = L.layerGroup().addTo(map);
        const bufferLayerGroup = L.layerGroup().addTo(map);
        const differenceExtractionLayerGroup = L.layerGroup().addTo(map);

        let currentMarker = null;

        // Definición del icono personalizado
        const customIcon = L.icon({
            iconUrl: 'https://github.com/Dchable16/Mapa_interactivo/raw/main/Captura-removebg-preview.png',
            iconSize: [20, 20],
            iconAnchor: [15, 30],
            popupAnchor: [0, -30]
        });

        function addMarker() {
            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            const markerName = document.getElementById('markerName').value;

            if (!isNaN(lat) && !isNaN(lon)) {
                removeMarker();
                currentMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'yellow-marker',
                        iconSize: [12, 12],
                        iconAnchor: [10, 20],
                    })
                }).addTo(map).bindPopup(markerName).openPopup();
                map.setView([lat, lon], 12);
            } else {
                alert("Por favor ingrese coordenadas válidas.");
            }
        }

        function removeMarker() {
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
                radius400Layer.clearLayers();
                radius800Layer.clearLayers();
                bufferLayerGroup.clearLayers();
                differenceExtractionLayerGroup.clearLayers();
                document.getElementById('lat').value = '';
                document.getElementById('lon').value = '';
                document.getElementById('markerName').value = '';
            }
        }

        function addRadius(radius) {
            if (currentMarker) {
                const latLng = currentMarker.getLatLng();
                const circle = L.circle(latLng, {
                    color: radius === 400 ? 'blue' : 'red',
                    fillOpacity: 0.2,
                    radius: radius
                });
                (radius === 400 ? radius400Layer : radius800Layer).addLayer(circle);
            } else {
                alert("Primero debe agregar un marcador.");
            }
        }

        function loadGeoJSON(url, layerName, type) {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`Error al cargar ${url}: ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    const colorMap = {
                        UsoSuelo: 'rgb(128, 0, 128)',
                        Poligono: 'rgb(255, 127, 80)',
                        Col: 'rgb(0, 150, 136)',
                        Ageb: url.includes('Ageb_urb_CDMX.geojson') ? 'rgb(135, 206, 235)' : 'rgb(128, 128, 0)',
                    };
                    const geoJsonLayer = L.geoJSON(data, {
                        pointToLayer: (feature, latlng) => L.marker(latlng, { icon: customIcon }),
                        style: { color: colorMap[type] || 'rgba(0, 0, 0, 0.5)', weight: 2, fillOpacity: 0.5 },
                        onEachFeature: (feature, layer) => layer.on('click', () => {
                            let popupContent = "<b>Atributos:</b><br>";
                            for (const key in feature.properties) {
                                popupContent += `${key}: ${feature.properties[key]}<br>`;
                            }
                            layer.bindPopup(popupContent).openPopup();
                        })
                    });
                    geoJsonLayers[type][layerName] = geoJsonLayer;
                })
                .catch(err => console.error('Error al cargar GeoJSON:', err));
        }

        const geoJsonFiles = [
            { url: 'Ageb_urb_CDMX.geojson', name: 'Ageb CDMX', type: 'Ageb' },
            { url: 'Ageb_urb_Edo_Mex.geojson', name: 'Ageb Edo. Mex.', type: 'Ageb' },
            { url: 'Uso_suelo_centro_barrio.geojson', name: 'Uso de suelo Centro Barrio', type: 'UsoSuelo' },
            { url: 'Uso_suelo_equipamento.geojson', name: 'Uso de suelo Equipamento', type: 'UsoSuelo' },
            { url: 'Uso_suelo_habitacional_comercio.geojson', name: 'Uso de suelo Habitacional Comercio', type: 'UsoSuelo' },
            { url: 'Uso_suelo_habitacional_comercio_planta_baja.geojson', name: 'Uso de suelo Planta Baja', type: 'UsoSuelo' },
            { url: 'Uso_suelo_habitacional_entrada.geojson', name: 'Uso de suelo Entrada', type: 'UsoSuelo' },
            { url: 'Uso_suelo_habitacional_mixto.geojson', name: 'Uso de suelo Mixto', type: 'UsoSuelo' },
            { url: 'Uso_suelo_habitacional_oficinas.geojson', name: 'Uso de suelo Oficinas', type: 'UsoSuelo' },
            { url: 'Uso_suelo_habitacional_plurifamiliar.geojson', name: 'Uso de suelo Plurifamiliar', type: 'UsoSuelo' },
            { url: 'Alcaldias_Ciudad_de_México.geojson', name: 'Alcaldías CDMX', type: 'Alcaldias' },
            { url: 'Municip_Estado_de_Mexico.geojson', name: 'Municipios Edo. Mex.', type: 'Alcaldias' },
            { url: 'Region_Vallejo.geojson', name: 'Poligono Región Vallejo', type: 'Poligonos' },
            { url: 'Poligono_Azcapotzalco.geojson', name: 'Poligono Azcapotzalco', type: 'Poligonos' },
            { url: 'Poligono_Benito_Juarez.geojson', name: 'Poligono Benito Juárez', type: 'Poligonos' },
            { url: 'Poligono_Cuauhtemoc.geojson', name: 'Poligono Cuauhtémoc', type: 'Poligonos' },
            { url: 'Poligono_Ecatepec.geojson', name: 'Poligono Ecatepec', type: 'Poligonos' },
            { url: 'Poligono_Miguel_Hidalgo.geojson', name: 'Poligono M. Hidalgo', type: 'Poligonos' },
            { url: 'Poligono_Nezahualcoyotl.geojson', name: 'Poligono Nezahualcoyotl', type: 'Poligonos' },
            { url: 'Col_Azcapotzalco.geojson', name: 'Colonias Azcapotzalco', type: 'Colonias' },
            { url: 'Col_Benito_Juarez.geojson', name: 'Colonias Benito Juárez', type: 'Colonias' },
            { url: 'Col_Cuauhtemoc.geojson', name: 'Colonias Cuauhtemoc', type: 'Colonias' },
            { url: 'Col_Ecatepec.geojson', name: 'Colonias Ecatepec', type: 'Colonias' },
            { url: 'Col_Miguel_Hidalgo.geojson', name: 'Colonias M. Hidalgo', type: 'Colonias' },
            { url: 'Col_Nezahualcoyotl.geojson', name: 'Colonias Nezahualcoyotl', type: 'Colonias' },
            { url: 'Tiendas_3B.geojson', name: 'Tiendas 3B', type: 'Competencias' }
        ];

        geoJsonFiles.forEach(file => loadGeoJSON(file.url, file.name, file.type));

        // Definición de las funciones faltantes (implementaciones básicas)
        function calculateDifference() {
            alert("Función para calcular la diferencia no implementada.");
        }

        function extractBufferData() {
            alert("Función para extraer datos de buffer no implementada.");
        }

        function extractDifferenceData() {
            alert("Función para extraer datos de diferencia no implementada.");
        }
    </script>
</body>
</html>
