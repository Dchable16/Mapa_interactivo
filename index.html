<!DOCTYPE html>
<html>
<head>
    <title>Mapa Interactivo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        #map { height: 500px; width: 100%; }
        .layer-control-container { background: white; padding: 10px; border-radius: 5px; }
        #loading-indicator { display: none; }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="realtime-location-button">Localización en Tiempo Real</button>
    <button id="useLocationBtn">Usar Localización</button>
    <button id="competencias-button">Competencias Cercanas</button>
    <div id="loading-indicator">Cargando...</div>
    <button id="download-report-btn">Descargar Reporte</button>
    <input type="text" id="lat" placeholder="Latitud">
    <input type="text" id="lon" placeholder="Longitud">

    <script>
        // Inicialización del mapa y capas base
        const map = L.map('map').setView([19.4326, -99.1332], 10);
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const googleRoadLayer = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { subdomains: ['mt0', 'mt1', 'mt2', 'mt3'] });
        const googleHybridLayer = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { subdomains: ['mt0', 'mt1', 'mt2', 'mt3'] });

        // Variables para capas GeoJSON y controles de capas
        const geoJsonLayersAgeb = {};
        const geoJsonLayersUsoSuelo = {};
        const geoJsonLayersAlcaldias = {};
        const geoJsonLayersPoligonos = {};
        const geoJsonLayersColonias = {};
        const geoJsonLayersCompetencias = {};
        const loadedLayers = new Set();
        const layerControlContainer = L.control({ position: 'topright' });

        // Capas de radios y diferencia
        const radius400Layer = L.circle([0, 0], { radius: 400 });
        const radius800Layer = L.circle([0, 0], { radius: 800 });
        const differenceLayerGroup = L.layerGroup();
        const bufferLayerGroup = L.layerGroup();
        const differenceExtractionLayerGroup = L.layerGroup();

        // Variables para geolocalización
        let watchId = null;
        let realtimeMarker = null;
        let isRealtimeLocationActive = false;
        let initialLocationReceived = false;
        let previousLatLng = null;

        // Variables para competencias
        const competenciasButton = document.getElementById('competencias-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        let poiMarkers = L.markerClusterGroup().addTo(map);

        // Funciones de carga de capas GeoJSON
        function loadGeoJSON(url, layerName, type, callback) {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    const geoJsonLayer = L.geoJSON(data).addTo(map);
                    assignLayerToGroup(geoJsonLayer, layerName, type, url);
                    loadedLayers.add(layerName);
                    updateLayerControls();
                    if (callback) callback();
                })
                .catch(err => console.error('Error al cargar GeoJSON:', err));
        }

        function assignLayerToGroup(geoJsonLayer, layerName, type, url) {
            switch (type) {
                case 'Ageb':
                    if (url === 'Ageb_urb_CDMX.geojson') agebCDMXLayer = geoJsonLayer;
                    else if (url === 'Ageb_urb_Edo_Mex.geojson') agebEdoMexLayer = geoJsonLayer;
                    geoJsonLayersAgeb[layerName] = geoJsonLayer;
                    break;
                case 'UsoSuelo': geoJsonLayersUsoSuelo[layerName] = geoJsonLayer; break;
                case 'Alcaldias': geoJsonLayersAlcaldias[layerName] = geoJsonLayer; break;
                case 'Municipios': geoJsonLayersAlcaldias[layerName] = geoJsonLayer; break;
                case 'Poligono': geoJsonLayersPoligonos[layerName] = geoJsonLayer; break;
                case 'Col': geoJsonLayersColonias[layerName] = geoJsonLayer; break;
                case 'Competencias': geoJsonLayersCompetencias[layerName] = geoJsonLayer; break;
            }
        }

        function loadLayer(layerName, type) {
            const layerUrls = {
                'Ageb CDMX': 'Ageb_urb_CDMX.geojson',
                'Ageb Edo. Mex.': 'Ageb_urb_Edo_Mex.geojson',
                'Uso de suelo Centro Barrio': 'Uso_suelo_centro_barrio.geojson',
                'Uso de suelo Equipamento': 'Uso_suelo_equipamento.geojson',
                'Uso de suelo Habitacional Comercio': 'Uso_suelo_habitacional_comercio.geojson',
                'Uso de suelo Planta Baja': 'Uso_suelo_habitacional_comercio_planta_baja.geojson',
                'Uso de suelo Entrada': 'Uso_suelo_habitacional_entrada.geojson',
                'Uso de suelo Mixto': 'Uso_suelo_habitacional_mixto.geojson',
                'Uso de suelo Oficinas': 'Uso_suelo_habitacional_oficinas.geojson',
                'Uso de suelo Plurifamiliar': 'Uso_suelo_habitacional_plurifamiliar.geojson',
                'Alcaldías CDMX': 'Alcaldias_Ciudad_de_México.geojson',
                'Municipios Edo. Mex.': 'Municip_Estado_de_Mexico.geojson',
                'Poligono Región Vallejo': 'Region_Vallejo.geojson',
                'Poligono Azcapotzalco': 'Poligono_Azcapotzalco.geojson',
                'Poligono Benito Juárez': 'Poligono_Benito_Juarez.geojson',
                'Poligono Cuauhtémoc': 'Poligono_Cuauhtemoc.geojson',
                'Poligono Ecatepec': 'Poligono_Ecatepec.geojson',
                'Poligono M. Hidalgo': 'Poligono_Miguel_Hidalgo.geojson',
                'Poligono Nezahualcoyotl': 'Poligono_Nezahualcoyotl.geojson',
                'Colonias Azcapotzalco': 'Col_Azcapotzalco.geojson',
                'Colonias Benito Juárez': 'Col_Benito_Juarez.geojson',
                'Colonias Cuauhtemoc': 'Col_Cuauhtemoc.geojson',
                'Colonias Ecatepec': 'Col_Ecatepec.geojson',
                'Colonias M. Hidalgo': 'Col_Miguel_Hidalgo.geojson',
                'Colonias Nezahualcoyotl': 'Col_Nezahualcoyotl.geojson',
                'Bodega Aurrera': 'Bodega_Aurrera.geojson',
                'Bodega Aurrera Express': 'Bodega_Aurrera_Express.geojson',
                'Chedraui Supercito': 'Chedraui_Supercito.geojson',
                ''Iglesias': 'Iglesias.geojson',
                'Mercados': 'Mercados.geojson',
                'Preescolar': 'Preescolar.geojson',
                'Primarias': 'Primarias.geojson',
                'Tiendas 3B': 'Tiendas_3B.geojson',
                'Tiendas Neto': 'Tiendas_Neto.geojson'
            };
            if (layerUrls[layerName]) loadGeoJSON(layerUrls[layerName], layerName, type);
            else console.error('URL de capa no encontrada para:', layerName);
        }

        // Función para actualizar controles de capas
        function updateLayerControls() {
            if (layerControlContainer && map.hasLayer(layerControlContainer)) map.removeControl(layerControlContainer);

            layerControlContainer.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'layer-control-container');
                div.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                        <i class="leaflet-control-layers-toggle" style="font-size: 24px; color: #000; "></i>
                    </div>
                    <h4 style="text-align: center; margin: 10;">Controles de Capas</h4>
                `;

                const baseMaps = { "OpenStreetMap": osmLayer, "Google Road": googleRoadLayer, "Google Hybrid": googleHybridLayer };
                const layerControlBase = L.control.layers(baseMaps, null, { collapsed: true });
                layerControlBase.addTo(map);
                div.appendChild(layerControlBase.getContainer());

                // Agregar controles para otras capas GeoJSON
                addLayerControl(div, geoJsonLayersAgeb);
                addLayerControl(div, geoJsonLayersUsoSuelo);
                addLayerControl(div, geoJsonLayersAlcaldias);
                addLayerControl(div, geoJsonLayersPoligonos);
                addLayerControl(div, geoJsonLayersColonias);
                addLayerControl(div, geoJsonLayersCompetencias);

                const radiusLayers = { "Radio 400m": radius400Layer, "Radio 800m": radius800Layer, "Diferencia Radios": differenceLayerGroup, "Buffer Ageb": bufferLayerGroup, "Diferencia Ageb": differenceExtractionLayerGroup };
                const radiusLayerControl = L.control.layers(null, radiusLayers, { collapsed: true });
                radiusLayerControl.addTo(map);
                div.appendChild(radiusLayerControl.getContainer());

                // Estilos y eventos para el contenedor
                setupLayerControlContainer(div);
                return div;
            };

            layerControlContainer.addTo(map);
        }

        function addLayerControl(div, layers) {
            const layerControl = L.control.layers(null, layers, { collapsed: true });
            layerControl.addTo(map);
            div.appendChild(layerControl.getContainer());
        }

        function setupLayerControlContainer(div) {
            div.style.width = '25px'; div.style.height = '25px'; div.style.overflow = 'hidden'; div.style.transition = 'width 0.3s ease-in-out, height 0.3s ease-in-out';
            div.addEventListener('mouseover', () => { div.style.width = '280px'; div.style.height = 'auto'; div.style.overflow = 'auto'; });
            div.addEventListener('mouseout', (event) => { if (!div.contains(event.relatedTarget)) { div.style.width = '25px'; div.style.height = '25px'; div.style.overflow = 'hidden'; } });
        }

        // Geolocalización en tiempo real
        document.getElementById('realtime-location-button').addEventListener('click', toggleRealtimeLocation);
        document.getElementById('useLocationBtn').addEventListener('click', useCurrentLocation);

        function toggleRealtimeLocation() {
            isRealtimeLocationActive ? stopRealtimeLocation() : startRealtimeLocation();
        }

        function startRealtimeLocation() {
            if (!navigator.geolocation) { alert("La geolocalización no es compatible con este navegador."); return; }
            document.getElementById('realtime-location-button').style.backgroundColor = 'lightgreen';
            isRealtimeLocationActive = true; initialLocationReceived = false; previousLatLng = null;

            navigator.geolocation.getCurrentPosition(updateLocation, handleLocationError, { enableHighAccuracy: true, timeout: 10000 });
            watchId = navigator.geolocation.watchPosition(updateLocation, handleLocationError, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        }

        function stopRealtimeLocation() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (realtimeMarker) map.removeLayer(realtimeMarker);
            document.getElementById('realtime-location-button').style.backgroundColor = 'white';
            isRealtimeLocationActive = false;
        }

        function updateLocation(position) {
            const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
            if (position.coords.accuracy > 100) { console.log(`Precisión baja: ${position.coords.accuracy} metros.`); return; }
            if (previousLatLng && latlng.distanceTo(previousLatLng) < 2) return;

            if (realtimeMarker) realtimeMarker.setLatLng(latlng);
            else realtimeMarker = L.marker(latlng).addTo(map);

            if (!initialLocationReceived) { map.setView(latlng, 18); initialLocationReceived = true; }
            previousLatLng = latlng;
        }

        function handleLocationError(error) {
            const errors = { 1: "Permiso denegado", 2: "Ubicación no disponible", 3: "Tiempo de espera agotado" };
            alert(`Error de geolocalización: ${errors[error.code] || "Desconocido"}`);
            stopRealtimeLocation();
        }

        function useCurrentLocation() {
            if (realtimeMarker) {
                const latlng = realtimeMarker.getLatLng();
                document.getElementById('lat').value = latlng.lat;
                document.getElementById('lon').value = latlng.lng;
                stopRealtimeLocation();
            } else {
                alert("La localización en tiempo real no está activa.");
            }
        }

        // Competencias cercanas
        competenciasButton.addEventListener('click', findNearbyPOIs);

        function findNearbyPOIs() {
            if (!currentMarker) { alert("Primero debe agregar un marcador."); return; }
            poiMarkers.clearLayers();
            loadingIndicator.style.display = 'block';

            const categories = {
                'hospital': { query: 'hospital or clinica', icon: 'https://github.com/Dchable16/Mapa_interactivo/raw/237ee2cf25559e6e6759e111262a54df5f1a9361/Hospital.png' },
                'marketplace': { query: 'Mercado', icon: 'https://github.com/Dchable16/Mapa_interactivo/raw/237ee2cf25559e6e6759e111262a54df5f1a9361/Mercado.png' },
                '3B': { query: 'Tienda 3B', icon: 'https://github.com/Dchable16/Mapa_interactivo/raw/1cb9732d5bff5cf91c2ef7fa17b017f5690ca732/Captura-removebg-preview.png' },
                'neto': { query: 'Tienda neto', icon: 'https://github.com/Dchable16/Mapa_interactivo/raw/237ee2cf25559e6e6759e111262a54df5f1a9361/Tienda_neto.png' },
                'school': { query: 'Escuela', icon: 'https://github.com/Dchable16/Mapa_interactivo/raw/237ee2cf25559e6e6759e111262a54df5f1a9361/Escuela.png' },
                'church': { query: 'Iglesia', icon: 'https://github.com/Dchable16/Mapa_interactivo/raw/237ee2cf25559e6e6759e1111262a54df5f1a9361/Iglesia.png' },
                'bodega aurrera': { query: 'Bodega Aurrera', icon: 'https://github.com/Dchable16/Mapa_interactivo/raw/237ee2cf25559e6e6759e111262a54df5f1a9361/Bodega_Aurrera.png' }
            };

            const latlng = currentMarker.getLatLng();
            let promises = [];
            let delay = 500;

            Object.entries(categories).forEach(([category, data]) => {
                const encodedQuery = encodeURIComponent(data.query);
                const viewbox = `${latlng.lng - 0.01},${latlng.lat - 0.01},${latlng.lng + 0.01},${latlng.lat + 0.01}`;
                const url = `https://nominatim.openstreetmap.org/search?q=${encodedQuery}&format=geojson&viewbox=${viewbox}&bounded=1&limit=10`;

                promises.push(new Promise((resolve) => {
                    setTimeout(() => {
                        fetch(url)
                            .then(response => {
                                if (!response.ok) throw new Error(`Error en la solicitud: ${response.status}`);
                                return response.json();
                            })
                            .then(data => resolve({ ...data, category }))
                            .catch(error => {
                                console.error("Error al buscar puntos de interés:", error);
                                alert("No se pudieron encontrar algunos puntos de interés cercanos.");
                                resolve(null);
                            });
                    }, delay);
                    delay += 500;
                }));
            });

            Promise.all(promises).then(results => {
                results.filter(result => result && result.features).forEach(result => {
                    result.features.forEach(feature => {
                        const icon = L.icon({ iconUrl: categories[result.category].icon, iconSize: [25, 25], iconAnchor: [16, 32], popupAnchor: [0, -32] });
                        const marker = L.marker([feature.geometry.coordinates[1], feature.geometry.coordinates[0]], { icon });
                        marker.bindPopup(`<b>${feature.properties.display_name}</b><br>Dirección: ${feature.properties.display_name}<br>Coordenadas: ${feature.geometry.coordinates[1]}, ${feature.geometry.coordinates[0]}`);
                        poiMarkers.addLayer(marker);
                    });
                });
                loadingIndicator.style.display = 'none';
            }).catch(error => {
                console.error("Error general al buscar puntos de interés:", error);
                alert("Ocurrió un error al buscar puntos de interés cercanos.");
                loadingIndicator.style.display = 'none';
            });
        }

        // Cargar capas GeoJSON iniciales
        const initialLayers = [
            { name: 'Ageb CDMX', type: 'Ageb' },
            { name: 'Ageb Edo. Mex.', type: 'Ageb' },
            { name: 'Uso de suelo Centro Barrio', type: 'UsoSuelo' },
            { name: 'Uso de suelo Equipamento', type: 'UsoSuelo' },
            { name: 'Uso de suelo Habitacional Comercio', type: 'UsoSuelo' },
            { name: 'Uso de suelo Planta Baja', type: 'UsoSuelo' },
            { name: 'Uso de suelo Entrada', type: 'UsoSuelo' },
            { name: 'Uso de suelo Mixto', type: 'UsoSuelo' },
            { name: 'Uso de suelo Oficinas', type: 'UsoSuelo' },
            { name: 'Uso de suelo Plurifamiliar', type: 'UsoSuelo' },
            { name: 'Alcaldías CDMX', type: 'Alcaldias' },
            { name: 'Municipios Edo. Mex.', type: 'Municipios' },
            { name: 'Poligono Región Vallejo', type: 'Poligono' },
            { name: 'Poligono Azcapotzalco', type: 'Poligono' },
            { name: 'Poligono Benito Juárez', type: 'Poligono' },
            { name: 'Poligono Cuauhtémoc', type: 'Poligono' },
            { name: 'Poligono Ecatepec', type: 'Poligono' },
            { name: 'Poligono M. Hidalgo', type: 'Poligono' },
            { name: 'Poligono Nezahualcoyotl', type: 'Poligono' },
            { name: 'Colonias Azcapotzalco', type: 'Col' },
            { name: 'Colonias Benito Juárez', type: 'Col' },
            { name: 'Colonias Cuauhtemoc', type: 'Col' },
            { name: 'Colonias Ecatepec', type: 'Col' },
            { name: 'Colonias M. Hidalgo', type: 'Col' },
            { name: 'Colonias Nezahualcoyotl', type: 'Col' },
            { name: 'Bodega Aurrera', type: 'Competencias' },
            { name: 'Bodega Aurrera Express', type: 'Competencias' },
            { name: 'Chedraui Supercito', type: 'Competencias' },
            { name: 'Iglesias', type: 'Competencias' },
            { name: 'Mercados', type: 'Competencias' },
            { name: 'Preescolar', type: 'Competencias' },
            { name: 'Primarias', type: 'Competencias' },
            { name: 'Tiendas 3B', type: 'Competencias' },
            { name: 'Tiendas Neto', type: 'Competencias' }
        ];

        initialLayers.forEach(layer => loadLayer(layer.name, layer.type));

        // Descargar reporte (función placeholder)
        document.getElementById('download-report-btn').addEventListener('click', generateReport);

        function generateReport() {
            alert("Función de reporte no implementada.");
        }
    </script>
</body>
</html>
