<!DOCTYPE html>
<html lang="es">
<head>
   <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; font-src 'self' data: https://cdn.jsdelivr.net; img-src 'self' data: https://cdn.jsdelivr.net maps.googleapis.com *.gstatic.com mapstreet.com tile.openstreetmap.org mt1.google.com mt0.google.com *.khms.googleapis.com;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo</title>
   <link rel="icon" href="favicon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <style>
        html, body { height: 100%; margin: 0; }
        #map { width: 100%; height: 100%; }
        .yellow-marker {
            background-color: #fff201;
            border: 3px solid black;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-block;
        }
        .marker-label {
            position: absolute;
            top: -40px; /* Ajustar la posición para evitar superposición */
            left: 25px;
            color: black;
            text-shadow: 0 0 2px yellow;
            font-weight: bold;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>Mapa Interactivo</h1>
    <div>
        <label for="lat">Latitud:</label>
        <input type="text" id="lat" value="19.4326">
        <label for="lon">Longitud:</label>
        <input type="text" id="lon" value="-99.1332">
        <label for="markerName">Nombre del Marcador:</label>
        <input type="text" id="markerName" value="Marcador Manual">
        <button onclick="addMarker()">Agregar Marcador</button>
        <button onclick="removeMarker()">Eliminar Marcador</button>
        <button onclick="addRadius(400)">Agregar Radio 400m</button>
        <button onclick="addRadius(800)">Agregar Radio 800m</button>
    </div>
    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        // Inicializar el mapa
        var map = L.map("map").setView([19.4326, -99.1332], 12);

        // Capas base
        var osmLayer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"
        }).addTo(map);

        var googleRoadLayer = L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}", {
            attribution: "Google"
        });

        var googleHybridLayer = L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", {
            attribution: "Google"
        });

        // Objeto para almacenar las capas GeoJSON
        var geoJsonLayersAgeb = {};
        var geoJsonLayersUsoSuelo = {};
        var geoJsonLayersAlcaldias = {}; // Nuevo objeto para las capas de alcaldías

        // Variables para el marcador y los radios
        var currentMarker = null;
        var currentLabel = null; // Variable para almacenar el nombre del marcador
        var radius400m = null;
        var radius800m = null;

        // Crear grupos de capas para los radios
        var radius400Layer = L.layerGroup().addTo(map);
        var radius800Layer = L.layerGroup().addTo(map);
        var radiusCutLayer = L.layerGroup().addTo(map); // Capa para el recorte

        // Función para agregar un marcador
        function addMarker() {
            var lat = parseFloat(document.getElementById('lat').value);
            var lon = parseFloat(document.getElementById('lon').value);
            var markerName = document.getElementById('markerName').value;

            if (!isNaN(lat) && !isNaN(lon)) {
                // Eliminar el marcador anterior si existe
                removeMarker();

                // Crear el nuevo marcador
                currentMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'yellow-marker',
                        iconSize: [12, 12],
                        iconAnchor: [10, 20],
                    })
                }).addTo(map);

                // Crear el nombre del marcador
                currentLabel = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'marker-label',
                        html: markerName,
                        iconSize: [100, 50],
                        iconAnchor: [50, 15]
                    })
                }).addTo(map);
            } else {
                alert("Por favor ingrese coordenadas válidas.");
            }
        }

        // Función para eliminar el marcador
        function removeMarker() {
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;

                // Eliminar el nombre del marcador
                if (currentLabel) {
                    map.removeLayer(currentLabel);
                    currentLabel = null;
                }

                // Eliminar los radios si existen
                if (radius400m) {
                    radius400Layer.removeLayer(radius400m);
                    radius400m = null;
                }
                if (radius800m) {
                    radius800Layer.removeLayer(radius800m);
                    radius800m = null;
                }
                if (radiusCutLayer) {
                    radiusCutLayer.clearLayers(); // Limpiar la capa de recorte
                }
            }
        }

        // Función para agregar radios
        function addRadius(radius) {
            if (currentMarker) {
                var latLng = currentMarker.getLatLng();
                var circle = L.circle(latLng, {
                    color: radius === 400 ? 'blue' : 'red',
                    fillOpacity: 0.2,
                    radius: radius
                });

                // Agregar el círculo al grupo de capas correspondiente
                if (radius === 400) {
                    radius400Layer.addLayer(circle);
                    radius400m = circle;

                    // Crear el recorte del círculo de 800 usando el de 400
                    if (radius800m) {
                        var cutCircle = L.circle(latLng, {
                            color: 'green',
                            fillOpacity: 0.1,
                            radius: 800
                        }).addTo(radiusCutLayer);

                        // Agregar lógica para recortar el círculo de 800
                        var cutPolygon = L.polygon(calculateCutPolygon(latLng, 400)).addTo(radiusCutLayer);
                    }
                } else if (radius === 800) {
                    radius800Layer.addLayer(circle);
                    radius800m = circle;
                }
            } else {
                alert("Primero debe agregar un marcador.");
            }
        }

        // Función para calcular los puntos del polígono de recorte
        function calculateCutPolygon(center, radius) {
            var points = [];
            for (var angle = 0; angle < 360; angle += 10) {
                var rad = angle * (Math.PI / 180);
                var point = [
                    center.lat + (radius / 111320) * Math.cos(rad), // Aproximación de latitud
                    center.lng + (radius / (111320 * Math.cos(center.lat * (Math.PI / 180)))) * Math.sin(rad) // Aproximación de longitud
                ];
                points.push(point);
            }
            return points;
        }

        // Cargar capas GeoJSON
        function loadGeoJSON(url, layerName, type) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var geoJsonLayer = L.geoJSON(data, {
                        onEachFeature: function (feature, layer) {
                            // Mostrar los atributos en un popup al hacer clic
                            layer.on('click', function () {
                                var properties = feature.properties;
                                var popupContent = "<b>Atributos:</b><br>";
                                for (var key in properties) {
                                    popupContent += key + ": " + properties[key] + "<br>";
                                }
                                layer.bindPopup(popupContent).openPopup();
                            });
                        }
                    });

                    // Agregar la capa al objeto correspondiente
                    if (type === 'Ageb') {
                        geoJsonLayersAgeb[layerName] = geoJsonLayer;
                    } else if (type === 'UsoSuelo') {
                        geoJsonLayersUsoSuelo[layerName] = geoJsonLayer;
                    } else if (type === 'AlcaldiasMunicipios') {
                        geoJsonLayersAlcaldias[layerName] = geoJsonLayer; // Agregar a alcaldías
                    }

                    // Actualizar los controladores de capas
                    updateLayerControls();
                })
                .catch(err => console.error('Error al cargar GeoJSON:', err));
        }

        // Controladores de capas
        var baseMaps = {
            "OpenStreetMap": osmLayer,
            "Google Road": googleRoadLayer,
            "Google Hybrid": googleHybridLayer
        };

        var layerControlBase = L.control.layers(baseMaps, null).addTo(map);
        var layerControlAgeb = L.control.layers(null, geoJsonLayersAgeb, { collapsed: true }).addTo(map);
        var layerControlUsoSuelo = L.control.layers(null, geoJsonLayersUsoSuelo, { collapsed: true }).addTo(map);
        var layerControlAlcaldias = L.control.layers(null, geoJsonLayersAlcaldias, { collapsed: true }).addTo(map); // Controlador para alcaldías

        // Agregar los grupos de capas de radios a los controladores
        layerControlBase.addOverlay(radius400Layer, "Radio 400m");
        layerControlBase.addOverlay(radius800Layer, "Radio 800m");
        layerControlBase.addOverlay(radiusCutLayer, "Recorte 800m - 400m");

        // Función para actualizar los controladores de capas
        function updateLayerControls() {
            layerControlAgeb.remove();
            layerControlUsoSuelo.remove();
            layerControlAlcaldias.remove(); // Remover controlador de alcaldías

            layerControlAgeb = L.control.layers(null, geoJsonLayersAgeb, { collapsed: true }).addTo(map);
            layerControlUsoSuelo = L.control.layers(null, geoJsonLayersUsoSuelo, { collapsed: true }).addTo(map);
            layerControlAlcaldias = L.control.layers(null, geoJsonLayersAlcaldias, { collapsed: true }).addTo(map); // Agregar nuevamente
        }

        // Llama a la función para cargar tus archivos GeoJSON
        loadGeoJSON('Ageb_urb_CDMX.geojson', 'Capa CDMX', 'Ageb');
        loadGeoJSON('Ageb_urb_Edo_Mex.geojson', 'Capa Edo Mex', 'Ageb');

        loadGeoJSON('Uso_suelo_centro_barrio.geojson', 'Capa Centro Barrio', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_equipamento.geojson', 'Capa Equipamento', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_comercio.geojson', 'Capa Habitacional Comercio', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_comercio_planta_baja.geojson', 'Capa Planta Baja', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_entrada.geojson', 'Capa Entrada', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_mixto.geojson', 'Capa Mixto', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_oficinas.geojson', 'Capa Oficinas', 'UsoSuelo');
        loadGeoJSON('Uso_suelo_habitacional_plurifamiliar.geojson', 'Capa Plurifamiliar', 'UsoSuelo');

        // Nuevas capas de alcaldías
        loadGeoJSON('Alcaldias_Ciudad_de_México.geojson', 'Capa Alcaldías CDMX', 'AlcaldiasMunicipios');
        loadGeoJSON('Municip_Estado_de_Mexico.geojson', 'Capa Municipios Edo. Mex.', 'AlcaldiasMunicipios');
        loadGeoJSON('Region_Vallejo.geojson', 'Capa Región Vallejo', 'AlcaldiasMunicipios');
        loadGeoJSON('Poligono_Azcapotzalco.geojson', 'Capa Azcapotzalco', 'AlcaldiasMunicipios');
        loadGeoJSON('Poligono_Benito_Juarez.geojson', 'Capa Benito Juárez', 'AlcaldiasMunicipios');
        loadGeoJSON('Poligono_Cuauhtemoc.geojson', 'Capa Cuauhtémoc', 'AlcaldiasMunicipios');
        loadGeoJSON('Poligono_Ecatepec.geojson', 'Capa Ecatepec', 'AlcaldiasMunicipios');
        loadGeoJSON('Poligono_Miguel_Hidalgo.geojson', 'Capa M. Hidalgo', 'AlcaldiasMunicipios');
        loadGeoJSON('Poligono_Nezahualcoyotl.geojson', 'Capa Nezahualcoyotl', 'AlcaldiasMunicipios');
        loadGeoJSON('Col_Azcapotzalco.geojson', 'Capa Col. Azcapotzalco', 'AlcaldiasMunicipios');
        loadGeoJSON('Col_Benito_Juarez.geojson', 'Capa Col. Benito Juárez', 'AlcaldiasMunicipios');
        loadGeoJSON('Col_Cuauhtemoc.geojson', 'Capa Col. Cuauhtemoc', 'AlcaldiasMunicipios');
        loadGeoJSON('Col_Ecatepec.geojson', 'Capa Col. Ecatepec', 'AlcaldiasMunicipios');
        loadGeoJSON('Col_Miguel_Hidalgo.geojson', 'Capa Col. M. Hidalgo', 'AlcaldiasMunicipios');
        loadGeoJSON('Col_Nezahualcoyotl.geojson', 'Capa Col. Nezahualcoyotl', 'AlcaldiasMunicipios');
    </script>
</body>
</html>
